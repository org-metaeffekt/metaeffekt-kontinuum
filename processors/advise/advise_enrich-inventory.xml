<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <!--
    Copyright 2024-2025 the original author or authors.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
    -->

    <parent>
        <groupId>com.metaeffekt.kontinuum</groupId>
        <artifactId>ae-kontinuum-processors</artifactId>
        <version>KONTINUUM-SNAPSHOT</version>
        <relativePath>../_common_/ae-kontinuum-processors.xml</relativePath>
    </parent>

    <artifactId>advise_enrich-inventory</artifactId>
    <packaging>pom</packaging>

    <properties>
        <!-- enricher -->
        <param.activate.msrc>true</param.activate.msrc>
        <param.activate.nvd>true</param.activate.nvd>
        <param.activate.certfr>true</param.activate.certfr>
        <param.activate.certeu>true</param.activate.certeu>
        <param.activate.certsei>true</param.activate.certsei>
        <param.activate.ghsa>true</param.activate.ghsa>
        <param.activate.ghsa.correlation>true</param.activate.ghsa.correlation>
        <param.activate.kev>true</param.activate.kev>
        <param.activate.epss>true</param.activate.epss>
        <param.activate.eol>true</param.activate.eol>
        <param.activate.osv>true</param.activate.osv>

        <param.activate.status>true</param.activate.status>
        <param.activate.keywords>true</param.activate.keywords>
        <param.activate.validation>false</param.activate.validation>

        <!-- osv ecosystem matcher -->
        <param.osv.matcher.maven>true</param.osv.matcher.maven>
        <param.osv.matcher.packagist>true</param.osv.matcher.packagist>
        <param.osv.matcher.rubygems>true</param.osv.matcher.rubygems>
        <param.osv.matcher.pypi>true</param.osv.matcher.pypi>
        <param.osv.matcher.hex>true</param.osv.matcher.hex>
        <param.osv.matcher.npm>true</param.osv.matcher.npm>
        <param.osv.matcher.crates_io>true</param.osv.matcher.crates_io>
        <param.osv.matcher.nuget>true</param.osv.matcher.nuget>
        <param.osv.matcher.cran>true</param.osv.matcher.cran>

        <!-- ghsa unreviewed filter -->
        <param.remove.ghsa.unreviewed>false</param.remove.ghsa.unreviewed>

        <param.exclude.nvd.equivalent.msrc>true</param.exclude.nvd.equivalent.msrc>
        <param.exclude.nvd.equivalent.osv>true</param.exclude.nvd.equivalent.osv>

        <param.dashboard.title>Vulnerability Assessment Dashboard</param.dashboard.title>
        <param.dashboard.subtitle>${project.artifactId}</param.dashboard.subtitle>
        <param.dashboard.footer>${project.artifactId}</param.dashboard.footer>

        <input.vulnerabilities.custom.dir>${project.basedir}/custom-vulnerabilities</input.vulnerabilities.custom.dir>
        <param.activate.vulnerabilities.custom>false</param.activate.vulnerabilities.custom>

    </properties>

    <build>
        <plugins>
            <plugin>
                <groupId>com.metaeffekt.artifact.analysis</groupId>
                <artifactId>ae-inventory-enrichment-plugin</artifactId>
                <version>${ae.artifact.analysis.version}</version>

                <executions>
                    <execution>
                        <id>set-inventory-info</id>
                        <goals>
                            <goal>set-inventory-info</goal>
                        </goals>
                        <configuration>
                            <active>true</active>

                            <entryId>vad-customization</entryId>
                            <values>
                                <Title>${param.dashboard.title}</Title>
                                <Subtitle>${param.dashboard.subtitle}</Subtitle>
                                <Footer>${param.dashboard.footer}</Footer>
                            </values>

                            <inventoryInputFile>${input.inventory.file}</inventoryInputFile>
                            <inventoryOutputFile>${output.inventory.file}</inventoryOutputFile>
                        </configuration>
                    </execution>

                    <execution>
                        <id>inventory-enrichment-advise-correlate-execution</id>
                        <goals>
                            <goal>enrich-inventory</goal>
                        </goals>
                        <configuration>
                            <inventoryInputFile>${output.inventory.file}</inventoryInputFile>
                            <inventoryOutputFile>${output.inventory.file}</inventoryOutputFile>
                            <mirrorDirectory>${env.vulnerability.mirror.dir}</mirrorDirectory>

                            <writeIntermediateInventories>false</writeIntermediateInventories>
                            <intermediateInventoriesDirectory>${output.tmp.dir}</intermediateInventoriesDirectory>
                            <storeIntermediateStepsInInventoryInfo>true</storeIntermediateStepsInInventoryInfo>

                            <securityPolicy>
                                <files>
                                    <file>${param.security.policy.file}</file>
                                </files>
                                <activeIds>${param.security.policy.active.ids}</activeIds>
                            </securityPolicy>

                            <correlationYamlEnrichment>
                                <active>${param.activate.correlation}</active>
                                <yamlFiles>
                                    <file>${param.correlation.dir}</file>
                                </yamlFiles>
                            </correlationYamlEnrichment>

                            <cpeDerivationEnrichment>
                                <active>${param.activate.nvd}</active>
                                <maxCorrelatedCpePerArtifact>${ae.cpe.correlation.limit}</maxCorrelatedCpePerArtifact>
                            </cpeDerivationEnrichment>

                            <msVulnerabilitiesByProductEnrichment>
                                <active>${param.activate.msrc}</active>
                            </msVulnerabilitiesByProductEnrichment>

                            <nvdMatchCveFromCpeEnrichment>
                                <active>${param.activate.nvd}</active>
                            </nvdMatchCveFromCpeEnrichment>

                            <nvdCveFillDetailsEnrichment>
                                <active>${param.activate.nvd}</active>
                            </nvdCveFillDetailsEnrichment>

                            <customVulnerabilitiesFromCpeEnrichment>
                                <active>${param.activate.vulnerabilities.custom}</active>
                                <vulnerabilityFiles>
                                    <file>${input.vulnerabilities.custom.dir}</file>
                                </vulnerabilityFiles>
                            </customVulnerabilitiesFromCpeEnrichment>

                            <customVulnerabilitiesFillDetailsEnrichment>
                                <active>${param.activate.vulnerabilities.custom}</active>
                                <vulnerabilityFiles>
                                    <file>${input.vulnerabilities.custom.dir}</file>
                                </vulnerabilityFiles>
                            </customVulnerabilitiesFillDetailsEnrichment>

                            <msrcAdvisorFillDetailsEnrichment>
                                <active>${param.activate.msrc}</active>
                                <excludeNvdEquivalent>${param.exclude.nvd.equivalent.msrc}</excludeNvdEquivalent>
                            </msrcAdvisorFillDetailsEnrichment>

                            <certFrAdvisorEnrichment>
                                <active>${param.activate.certfr}</active>
                            </certFrAdvisorEnrichment>

                            <certEuAdvisorEnrichment>
                                <active>${param.activate.certeu}</active>
                            </certEuAdvisorEnrichment>

                            <certSeiAdvisorEnrichment>
                                <active>${param.activate.certsei}</active>
                            </certSeiAdvisorEnrichment>

                            <kevEnrichment>
                                <active>${param.activate.kev}</active>
                            </kevEnrichment>

                            <epssEnrichment>
                                <active>${param.activate.epss}</active>
                            </epssEnrichment>

                            <osvVulnerabilitiesEnrichment>
                                <active>${param.activate.osv}</active>

                                <!-- ecosystem configurations -->
                                <maven>${param.osv.matcher.maven}</maven>
                                <packagist>${param.osv.matcher.packagist}</packagist>
                                <rubygems>${param.osv.matcher.rubygems}</rubygems>
                                <pypi>${param.osv.matcher.pypi}</pypi>
                                <hex>${param.osv.matcher.hex}</hex>
                                <npm>${param.osv.matcher.npm}</npm>
                                <crates_io>${param.osv.matcher.crates_io}</crates_io>
                                <nuget>${param.osv.matcher.nuget}</nuget>
                                <cran>${param.osv.matcher.cran}</cran>

                                <!-- FIXME-KKL we need to desparately fix this; this naming very irritating -->
                                <!-- true: removes unreviewed entries -->
                                <!-- false: keep unreviewed entries (default) -->
                                <githubReviewed>${param.remove.ghsa.unreviewed}</githubReviewed>

                                <excludeNvdEquivalent>${param.exclude.nvd.equivalent.osv}</excludeNvdEquivalent>

                            </osvVulnerabilitiesEnrichment>

                            <cweFillDetailsEnrichment>
                                <active>${param.activate.cwe}</active>
                            </cweFillDetailsEnrichment>

                            <capecFillDetailsEnrichment>
                                <active>${param.activate.capec}</active>
                            </capecFillDetailsEnrichment>

                            <csafVulnerabilitiesEnrichment>
                                <active>${param.activate.csaf}</active>
                            </csafVulnerabilitiesEnrichment>

                            <csafAdvisorEnrichment>
                                <active>${param.activate.csaf}</active>
                            </csafAdvisorEnrichment>

                            <!-- Review if listed properties are necessary -->
                            <eolEnrichment>
                                <active>${param.activate.eol}</active>
                            </eolEnrichment>

                            <osvAdvisorFillDetailsEnrichment>
                                <active>${param.activate.osv}</active>
                                <includeAdvisoryProviders></includeAdvisoryProviders>
                                <excludeNvdEquivalent></excludeNvdEquivalent> <!-- Ensure this is supported by other configurations as well (osv & msrc)-->
                            </osvAdvisorFillDetailsEnrichment>

                            <vulnerabilityStatusEnrichment>
                                <active>${param.activate.status}</active>
                                <statusFiles>
                                    <file>${param.assessment.dir}</file>
                                </statusFiles>
                                <activeLabels>${assessment.labels}</activeLabels>
                            </vulnerabilityStatusEnrichment>

                            <vulnerabilityKeywordsEnrichment>
                                <active>${param.activate.keywords}</active>
                                <yamlFiles>
                                    <file>${param.context.dir}</file>
                                </yamlFiles>
                                <activeLabels>${keywords.labels}</activeLabels>
                            </vulnerabilityKeywordsEnrichment>

                            <inventoryValidationEnrichment>
                                <active>${param.activate.validation}</active>
                                <failOnValidationErrors>false</failOnValidationErrors>
                                <addAsCorrelationWarnings>true</addAsCorrelationWarnings>

                                <additionalCpeIsNotEffectiveInventoryValidator/>
                                <multipleArtifactsAndVersionsOnVulnerabilityInventoryValidator>
                                    <versionLevel>minor</versionLevel>
                                </multipleArtifactsAndVersionsOnVulnerabilityInventoryValidator>
                                <artifactAndCpeVersionsDifferGreatlyInventoryValidator></artifactAndCpeVersionsDifferGreatlyInventoryValidator>
                                <vulnerabilityInvalidNameValidator/>
                            </inventoryValidationEnrichment>

                            <!-- FIXME-KKL: review with YWI -->
                            <!-- Always active / inactive -->
                            <vulnerabilityFilterEnrichment>
                                <active>false</active>
                            </vulnerabilityFilterEnrichment>

                            <vulnerabilityAssessmentDashboardEnrichment>
                                <active>false</active>
                            </vulnerabilityAssessmentDashboardEnrichment>

                            <advisorPeriodicEnrichment>
                                <active>false</active>
                            </advisorPeriodicEnrichment>

                            <vulnerabilityStatusPostProcessingEnrichment>
                                <active>true</active>
                            </vulnerabilityStatusPostProcessingEnrichment>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-enforcer-plugin</artifactId>
                <version>3.5.0</version>
                <executions>
                    <execution>
                        <id>enforce-property</id>
                        <goals>
                            <goal>enforce</goal>
                        </goals>
                        <configuration>
                            <rules>
                                <requireProperty>
                                    <property>input.inventory.file</property>
                                </requireProperty>
                                <requireProperty>
                                    <property>output.inventory.file</property>
                                </requireProperty>
                                <requireProperty>
                                    <property>param.context.dir</property>
                                </requireProperty>
                                <requireProperty>
                                    <property>param.assessment.dir</property>
                                </requireProperty>
                                <requireProperty>
                                    <property>param.security.policy.file</property>
                                </requireProperty>
                                <requireProperty>
                                    <property>param.correlation.dir</property>
                                </requireProperty>
                                <requireProperty>
                                    <property>env.vulnerability.mirror.dir</property>
                                </requireProperty>
                                <requireProperty>
                                    <property>output.tmp.dir</property>
                                </requireProperty>
                            </rules>
                            <fail>true</fail>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
