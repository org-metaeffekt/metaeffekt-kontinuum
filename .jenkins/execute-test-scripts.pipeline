#!/usr/bin/env groovy
pipeline {
    agent {
        // bound to astronaut as various pre-conditions are required:
        // - docker required
        label 'metaeffekt-astronaut'
    }

    stages {
        stage('Clean Up') {
            steps {
                script {
                    sh 'rm -rf .logs'
                    sh 'rm -rf tests/target'
                }
            }
        }

        stage('Checkout metaeffekt-workbench') {
            steps {
                script {
                    sh 'mkdir -p .metaeffekt-workbench'
                    dir ('.metaeffekt-workbench') {
                        withCredentials([usernamePassword(credentialsId: 'JenkinsGithubAccess', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            git url: 'https://github.com/org-metaeffekt/metaeffekt-workbench.git', branch: 'main', credentialsId: 'JenkinsGithubAccess'
                        }
                    }
                }
            }
        }

        stage('Checkout metaeffekt-core') {
            steps {
                script {
                    sh 'mkdir -p .metaeffekt-core'
                    dir ('.metaeffekt-core') {
                        withCredentials([usernamePassword(credentialsId: 'JenkinsGithubAccess', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            git url: 'https://github.com/org-metaeffekt/metaeffekt-core.git', branch: 'master', credentialsId: 'JenkinsGithubAccess'
                        }
                    }
                }
            }
        }
        stage('Build metaeffekt-core (skipping tests and javadoc)') {
            steps {
                dir ('.metaeffekt-core') {
                    withMaven(jdk: 'ZULU8_mac_mini', maven: 'maven-3.9.6') {
                        sh 'mvn -B clean install -DskipTests -Dmaven.javadoc.skip=true'
                    }
                }
            }
        }

        stage('Checkout metaeffekt-artifact-analysis') {
            steps {
                script {
                    sh 'mkdir -p .metaeffekt-artifact-analysis'
                    dir ('.metaeffekt-artifact-analysis') {
                        withCredentials([usernamePassword(credentialsId: 'JenkinsGithubAccess', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                            git url: 'https://github.com/org-metaeffekt/metaeffekt-artifact-analysis.git', branch: 'main', credentialsId: 'JenkinsGithubAccess'
                        }
                    }
                }
            }
        }
        stage('Build metaeffekt-artifact-analysis (skipping tests)') {
            steps {
                dir ('.metaeffekt-artifact-analysis') {
                    withMaven(jdk: 'ZULU8_mac_mini', maven: 'maven-3.9.6') {
                        sh 'mvn -B clean install -DskipTests  -Dmaven.javadoc.skip=true'
                    }
                }
            }
        }

        stage('Configure metaeffekt-kontinuum') {
            steps {
                sh 'echo "EXTERNAL_WORKBENCH_DIR=\"$(pwd)/.metaeffekt-workbench\"" > external.rc'

                // this is effectively workspace/.vulnerability-mirror; so next to the jobs workspace; reconsider as shared
                sh 'echo "EXTERNAL_VULNERABILITY_MIRROR_DIR=\"$(dirname $(pwd))/.vulnerability-mirror\"" >> external.rc'

                //
                sh 'echo "EXTERNAL_VULNERABILITY_MIRROR_URL=\"http://ae-scanner/mirror/index/ae-mirror-index_gen5.tar.gz\"" >> external.rc'
                sh 'echo "EXTERNAL_VULNERABILITY_MIRROR_NAME=\"ae-mirror-index_gen5.tar.gz\"" >> external.rc'

                sh 'echo "AE_CORE_VERSION=\"HEAD-SNAPSHOT\"" >> external.rc'
                sh 'echo "AE_ARTIFACT_ANALYSIS_VERSION=\"HEAD-SNAPSHOT\"" >> external.rc'
                sh 'echo "DUMP_LOGS=\"true\"" >> external.rc'
            }
        }

        stage('Run 001_complete pipeline') {
            steps {
                withMaven(maven: 'maven-3.9.6') {
                    sh './tests/scripts/pipelines/001_complete.sh'
                }
            }
        }

        stage('Run 001_remote pipeline') {
            steps {
                withMaven(maven: 'maven-3.9.6') {
                    sh './tests/scripts/pipelines/001_remote.sh'
                }
            }
        }

        stage('Run 002_only-process-inventories pipeline') {
            steps {
                withMaven(maven: 'maven-3.9.6') {
                    sh './tests/scripts/pipelines/002_only-process-inventories.sh'
                }
            }
        }

        stage('Run 003_only-docker pipeline') {
            steps {
                withMaven(maven: 'maven-3.9.6') {
                    sh './tests/scripts/pipelines/003_only-docker.sh'
                }
            }
        }
    }
}
